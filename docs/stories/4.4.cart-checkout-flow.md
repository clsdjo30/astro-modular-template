# Story 4.4: Cart & Checkout Flow

## Status
Done

## Story
**As a** solo freelancer,  
**I want** a cart and checkout flow,  
**so that** users can place orders end-to-end.

## Acceptance Criteria
1. Cart supports add/remove/update quantity and shows totals.
2. Cart state is stored server-side in session (no DB-persistent cart in v1).
3. Checkout collects customer details and confirms order submission.
4. Flow works without external payment providers in v1 unless explicitly enabled.

## Tasks / Subtasks
- [x] Implement cart API routes (AC: 1, 2)
  - [x] `GET /api/v1/cart`
  - [x] `POST /api/v1/cart/items` (add)
  - [x] `PATCH /api/v1/cart/items/{productId}` (update quantity)
  - [x] `DELETE /api/v1/cart/items/{productId}` (remove)
  - [x] Use session cart structure defined in data models.
- [x] Add frontend cart services (AC: 1, 2)
  - [x] Add `cartService` under `templates/presets/commerce/src/services/`.
  - [x] Use fetch with credentials and `PUBLIC_API_BASE_URL`.
- [x] Add cart and checkout pages (AC: 1, 3, 4)
  - [x] Cart page: `/cart` -> `templates/presets/commerce/src/pages/cart.astro`
  - [x] Checkout page: `/checkout` -> `templates/presets/commerce/src/pages/checkout.astro`
  - [x] Add minimal client-side script for cart interactions (no framework).
  - [x] Checkout submits customer details to order creation endpoint.
- [x] Verify no external payments (AC: 4)
  - [x] Ensure no payment provider SDKs are included.

## Dev Notes
### Architecture References
- Cart endpoints and rules. [Source: architecture/api-specification-rest.md]
- Cart data structure in session. [Source: architecture/data-models.md#Session]
- Frontend services and scripts. [Source: architecture/frontend-architecture.md#Frontend Services Layer]

### Dependencies
- Story 4.1 (API skeleton).
- Story 4.3 (product pages/services).
- Story 4.5 (order creation endpoint for checkout submission).

### Scope Boundaries (v1)
- Cart is session-only; no persistent cart table.
- No payment integrations in v1.

### File Locations
- API routes: `packages/api/src/routes/cart.routes.ts`
- API controllers/services: `packages/api/src/controllers/cart.controller.ts`, `packages/api/src/services/cart.service.ts`
- Frontend services: `templates/presets/commerce/src/services/`
- Pages: `templates/presets/commerce/src/pages/cart.astro`, `templates/presets/commerce/src/pages/checkout.astro`
- Script: `templates/presets/commerce/src/scripts/cart.ts`

## Testing
Relevant standards from architecture:
- Backend integration tests in `packages/api`. [Source: architecture/testing-strategy.md#Test Organization]
Manual verification:
- Add/remove/update cart items and see totals update.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-18 | v0.1 | Drafted Story 4.4 | Bob (SM) |
| 2026-01-18 | v0.1 | Added cart API and checkout UI wiring. | James |

## Dev Agent Record
### Agent Model Used
GPT-5

### Debug Log References
- `GET /api/v1/cart`
- `POST /api/v1/cart/items`
- `PATCH /api/v1/cart/items/{productId}`
- `DELETE /api/v1/cart/items/{productId}`
- Cart session persistence via cookie verified

### Completion Notes List
- Added session-backed cart endpoints with add/update/remove and totals.
- Added cart service and client script, plus cart and checkout pages.
- Checkout posts to `/api/v1/orders` (requires Story 4.5 endpoint).

### File List
- packages/api/src/services/cart.service.ts
- packages/api/src/controllers/cart.controller.ts
- packages/api/src/routes/cart.routes.ts
- packages/api/src/app.ts
- packages/api/src/types/express-session.d.ts
- templates/presets/commerce/src/services/cartService.ts
- templates/presets/commerce/src/scripts/cart.ts
- templates/presets/commerce/src/scripts/checkout.ts
- templates/presets/commerce/src/pages/cart.astro
- templates/presets/commerce/src/pages/checkout.astro

## QA Results
