# Story 2.2: Patch-Point Conventions

## Status
Done

## Story
**As a** solo freelancer,  
**I want** explicit patch points in base templates,  
**so that** module additions are safe and predictable.

## Acceptance Criteria
1. Patch points are clearly marked and documented in core templates.
2. CLI can insert module snippets at patch points deterministically.
3. CLI fails safely if a patch point is missing or modified.

## Tasks / Subtasks
- [x] Define patch-point marker format (AC: 1, 2)
  - [x] Define explicit marker format: `<!-- @mod:begin <name> -->` and `<!-- @mod:end <name> -->` (single-line, no indentation inside marker lines).
  - [x] Define patch-point naming rules: kebab-case identifiers (e.g., `head-meta`, `body-end`).
  - [x] Document insertion rules: append/prepend/replace.
- [x] Add patch points to base template (AC: 1)
  - [x] Insert marker blocks in relevant base template files for future module insertion.
  - [x] Document patch-point locations in a short README or manifest guide.
- [x] Implement deterministic insertion logic in CLI (AC: 2, 3)
  - [x] Add CLI helper that locates marker blocks and applies insertion rules.
  - [x] Ensure idempotence: insertion is skipped if marker block already contains module block with same module id.
  - [x] Fail safely with a clear error when a patch point is missing or modified.
- [x] Add tests for patch-point behavior (AC: 2, 3)
  - [x] Unit tests for marker detection and insertion rules.
  - [x] Integration test using a real YAML manifest validated by the Zod schema (Story 2.1).

## Dev Notes
### Architecture References
- Generator idempotence: patch-point insertions must be marker-based and idempotent. [Source: architecture/coding-standards.md#Critical Fullstack Rules]
- Repo structure: CLI in `packages/cli`, templates in `templates/base`, manifests in `packages/modules`. [Source: architecture/unified-project-structure.md#Unified Project Structure]
- Testing: CLI requires unit + integration tests. [Source: architecture/testing-strategy.md#Test Organization]

### File Locations
- CLI insertion logic: `packages/cli/`  
- Base template files: `templates/base/`  
- Manifest examples: `packages/modules/`  

### Marker Contract (v1)
- Marker format: `<!-- @mod:begin <name> -->` ... `<!-- @mod:end <name> -->`
- Names are kebab-case and must match manifest patch-point references.
- Indentation: marker lines are not indented; inserted content may be indented as needed.
- Idempotence: if a module block is already present within a patch-point, CLI must skip reinsertion.

## Testing
Relevant standards from architecture:
- CLI requires unit + integration tests. [Source: architecture/testing-strategy.md#Test Organization]
- Use Vitest 2.0.0. [Source: architecture/tech-stack.md#Technology Stack Table]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-18 | v0.1 | Drafted Story 2.2 | Bob (SM) |

## Dev Agent Record
### Agent Model Used
GPT-5

### Debug Log References
- CLI tests not run here; requires pnpm install in packages/cli.
- CLI tests passed after moving yaml to devDependencies and aligning example manifest marker.

### Completion Notes List
- Added patch markers to base layout and documented patch points.
- Added CLI helper for deterministic insertion and idempotence checks.
- Added unit and integration tests (YAML manifest validated via schema).
- Tests green: `pnpm -C packages/cli test`.

### File List
- templates/base/src/layouts/BaseLayout.astro
- docs/patch-points.md
- packages/cli/src/patch.ts
- packages/cli/tests/patch.test.ts
- packages/cli/tests/patch-integration.test.ts
- packages/cli/package.json
- packages/modules/example/manifest.yaml

## QA Results
