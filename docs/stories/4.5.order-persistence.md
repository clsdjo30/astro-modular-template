# Story 4.5: Order Persistence

## Status
Done

## Story
**As a** solo freelancer,  
**I want** orders saved in the database,  
**so that** submissions are reliable and reviewable.

## Acceptance Criteria
1. Orders are stored in the database with line items.
2. API provides a simple order creation endpoint.
3. Basic validation prevents empty or invalid orders.

## Tasks / Subtasks
- [x] Add order persistence in the data layer (AC: 1)
  - [x] Add Knex migration for `orders` and `order_items` tables (per schema).
  - [x] Add repository methods to create orders and line items.
- [x] Implement order endpoints (AC: 2, 3)
  - [x] `POST /api/v1/orders` (public, guest allowed).
  - [x] `GET /api/v1/orders` and `GET /api/v1/orders/{id}` (admin-only).
  - [x] Add Zod validation for order payloads (customer details, cart items).
  - [x] Apply rate limiting to `POST /api/v1/orders`.
- [x] Wire checkout to order creation (AC: 2)
  - [x] Use the checkout form to call `POST /api/v1/orders`.
  - [x] Clear cart on successful order creation.

## Dev Notes
### Architecture References
- Order endpoints and access rules. [Source: architecture/api-specification-rest.md]
- Order and order item models. [Source: architecture/data-models.md#Order]
- MariaDB schema and indexes. [Source: architecture/database-schema.md]
- Rate limiting on orders. [Source: architecture/backend-architecture.md#Authentication and Authorization]

### Dependencies
- Story 4.1 (API skeleton).
- Story 4.4 (checkout flow).

### Scope Boundaries (v1)
- No payments; status stays `pending` by default.
- Admin-only order detail; no public order lookup tokens in v1.

### File Locations
- API routes: `packages/api/src/routes/orders.routes.ts`
- API controllers/services: `packages/api/src/controllers/orders.controller.ts`, `packages/api/src/services/orders.service.ts`
- Repositories: `packages/api/src/repositories/order.repo.ts`
- Migrations: `packages/api/src/db/migrations/`

## Testing
Relevant standards from architecture:
- Backend integration tests in `packages/api`. [Source: architecture/testing-strategy.md#Test Organization]
Manual verification:
- Create order via checkout and verify DB persistence.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-18 | v0.1 | Drafted Story 4.5 | Bob (SM) |
| 2026-01-18 | v0.1 | Added order persistence and endpoints. | James |

## Dev Agent Record
### Agent Model Used
GPT-5

### Debug Log References
- `pnpm -C packages/api build`
- `POST /api/v1/orders`
- `GET /api/v1/orders`
- `GET /api/v1/orders/{id}`

### Completion Notes List
- Added orders migration, repository, and service for create/list/detail.
- Added order endpoints with rate limiting and admin guards.
- Order creation clears the session cart.

### File List
- packages/api/src/db/migrations/202601200001_create_orders_tables.js
- packages/api/src/repositories/order.repo.ts
- packages/api/src/services/orders.service.ts
- packages/api/src/controllers/orders.controller.ts
- packages/api/src/routes/orders.routes.ts
- packages/api/src/middleware/rate-limit.middleware.ts
- packages/api/src/app.ts

## QA Results
