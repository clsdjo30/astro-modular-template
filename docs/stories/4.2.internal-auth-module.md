# Story 4.2: Internal Auth Module (Minimal, Extensible)

## Status
Done

## Story
**As a** solo freelancer,  
**I want** internal auth with email/password and sessions/JWT,  
**so that** access is self-hosted and controllable.

## Acceptance Criteria
1. Auth supports email/password login and session handling.
2. Roles are supported (admin/customer) with endpoint protection.
3. Auth design allows optional OAuth providers later without refactoring core flows.
4. No full back-office admin UI is required in v1 (optional minimal view orders page only).

## Tasks / Subtasks
- [x] Add auth routes and controllers (AC: 1, 2)
  - [x] Implement `POST /api/v1/auth/login`, `POST /api/v1/auth/logout`, `GET /api/v1/auth/me`.
  - [x] Keep `POST /api/v1/auth/register` disabled by default in v1.
  - [x] Add Zod validation for auth payloads.
- [x] Add auth service and password hashing (AC: 1)
  - [x] Use Argon2id for password hashing and verification.
  - [x] Add user repository methods for lookup by email.
  - [x] Ensure session creation/rotation on login.
- [x] Add session middleware and role guards (AC: 2, 3)
  - [x] Use `express-session` with `express-mysql-session` in production and in-memory store in dev.
  - [x] Add `requireAuth` and `requireRole("admin")` middleware.
  - [x] Keep roles as enum `"admin" | "customer"` (no RBAC table in v1).
- [x] Document extensibility (AC: 3)
  - [x] Note how to add OAuth later without changing core auth flow (hook point in auth service).

## Dev Notes
### Architecture References
- Auth endpoints and v1 notes. [Source: architecture/api-specification-rest.md]
- Session store + error shape. [Source: architecture/backend-architecture.md#Authentication and Authorization]
- Password hashing: Argon2id. [Source: architecture/security-and-performance.md#Authentication Security]
- User model and role enum. [Source: architecture/data-models.md#User]

### Dependencies
- Story 4.1 (API skeleton + middleware structure).

### Scope Boundaries (v1)
- No OAuth providers implemented in v1.
- No full admin UI (optional minimal orders page is outside API scope).

### File Locations
- Routes: `packages/api/src/routes/auth.routes.ts`
- Controllers: `packages/api/src/controllers/auth.controller.ts`
- Services: `packages/api/src/services/auth.service.ts`
- Middleware: `packages/api/src/middleware/auth.middleware.ts`, `role.middleware.ts`

## Testing
Relevant standards from architecture:
- Backend integration tests in `packages/api`. [Source: architecture/testing-strategy.md#Test Organization]
Manual verification:
- Login returns session cookie and `GET /api/v1/auth/me` responds with user.
- Logout clears session.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-18 | v0.1 | Drafted Story 4.2 | Bob (SM) |
| 2026-01-18 | v0.1 | Added auth routes, sessions, and hashing. | James |

## Dev Agent Record
### Agent Model Used
GPT-5

### Debug Log References
- `pnpm -C packages/api install`
- `pnpm -C packages/api build`
- `node packages/api/dist/server.js`
- `POST /api/v1/auth/login`, `GET /api/v1/auth/me`, `POST /api/v1/auth/logout`

### Completion Notes List
- Added auth routes/controllers with Zod validation and disabled register.
- Added Argon2-based auth service and user repository.
- Added session middleware with dev memory store and MySQL store for production.
- Added auth/role guards for endpoint protection.

### File List
- packages/api/package.json
- packages/api/src/config/env.ts
- packages/api/src/app.ts
- packages/api/src/controllers/auth.controller.ts
- packages/api/src/middleware/auth.middleware.ts
- packages/api/src/middleware/role.middleware.ts
- packages/api/src/middleware/session.middleware.ts
- packages/api/src/repositories/user.repo.ts
- packages/api/src/routes/auth.routes.ts
- packages/api/src/services/auth.service.ts
- packages/api/src/types/express-session.d.ts
- packages/api/src/middleware/error.middleware.ts

## QA Results
