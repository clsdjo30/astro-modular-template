# Story 4.1: Backend API Service Skeleton (Self-Hosted)

## Status
Done

## Story
**As a** solo freelancer,  
**I want** a self-hosted JSON API service wired to the commerce preset,  
**so that** dynamic workflows run separately from the Astro UI.

## Acceptance Criteria
1. Commerce preset includes a backend JSON API scaffold compatible with o2switch Node.js hosting.
2. API connects to MariaDB by default, with PostgreSQL supported, via a single data layer.
3. API is included only for backend-enabled presets; Astro remains frontend-only.

## Tasks / Subtasks
- [ ] Scaffold API service package (AC: 1, 3)
  - [ ] Create `packages/api/` with `src/app.ts` and `src/server.ts`.
  - [ ] Add basic Express app with JSON middleware and health routes.
  - [ ] Add `GET /healthz` and `GET /readyz` endpoints.
  - [ ] Ensure API package is referenced only by backend-enabled presets.
- [ ] Add database layer (AC: 2)
  - [ ] Add Knex configuration in `packages/api/src/db/index.ts`.
  - [ ] Support MariaDB by default with PostgreSQL as an option.
  - [ ] Add a minimal migrations folder scaffold.
- [ ] Add core middleware (AC: 1)
  - [ ] Add error middleware that normalizes responses to `{ error: { code, message, details? } }`.
  - [ ] Add request ID logging via Pino.
  - [ ] Add CORS allowlist via `API_ALLOWED_ORIGIN` with credentials enabled.
- [ ] Verify local run (AC: 1, 2)
  - [ ] Ensure API can boot with local env values and connect to DB.
  - [ ] Confirm health and readiness endpoints return expected payloads.

## Dev Notes
### Architecture References
- Backend structure and folder layout. [Source: architecture/backend-architecture.md#Service Architecture (Traditional Server)]
- Knex + migrations, thin repository layer. [Source: architecture/backend-architecture.md#Database Architecture]
- Error shape and session/CORS notes. [Source: architecture/backend-architecture.md#Authentication and Authorization]
- CORS + env variable `API_ALLOWED_ORIGIN`. [Source: architecture/frontend-architecture.md#CORS + Session Cookies (o2switch)]

### Dependencies
- Story 1.1 (repo structure + base template).
- Story 5.2 (o2switch deployment preset) will consume this API package.

### Scope Boundaries (v1)
- No business routes yet (auth/products/cart/orders in later stories).
- API is a separate Node service; no backend logic inside Astro.

### File Locations
- API service: `packages/api/`
- DB layer: `packages/api/src/db/`
- Middleware: `packages/api/src/middleware/`

## Testing
Relevant standards from architecture:
- Backend integration tests live in `packages/api` (or `packages/backend`). [Source: architecture/testing-strategy.md#Test Organization]
Manual verification:
- Start API locally and hit `/healthz` and `/readyz`.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-18 | v0.1 | Drafted Story 4.1 | Bob (SM) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
